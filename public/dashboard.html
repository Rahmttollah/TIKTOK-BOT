<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TikTok View Bot</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <div class="header">
                <h1>ü§ñ TikTok View Bot</h1>
                <div class="user-info">
                    <span>Welcome, <strong id="userEmail"></strong></span>
                    <button onclick="logout()" class="btn logout">Logout</button>
                </div>
            </div>
            
            <!-- TikTok Bot Section -->
            <div class="section">
                <h2>üé¨ TikTok View Bot</h2>
                
                <div class="input-group">
                    <label>Target Views:</label>
                    <input type="number" id="tiktokTarget" placeholder="e.g., 100" min="1" value="50" required>
                </div>
                
                <div class="input-group">
                    <label>TikTok URL:</label>
                    <input type="text" id="tiktokUrl" placeholder="Paste any TikTok URL" 
                           value="https://www.tiktok.com/@rally.clipping.ea/video/7566306949894016263" required>
                    <button type="button" class="btn paste-btn" onclick="pasteUrl()">üìã Paste URL</button>
                </div>
                
                <button class="btn start-btn" onclick="startBot()">üöÄ Start TikTok Bot</button>
                
                <!-- History Section -->
                <div class="history-section">
                    <h3>üìú Recent Links</h3>
                    <div id="historyList" class="history-list">
                        Loading history...
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>üìä Live Stats</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <label>Status:</label>
                            <span id="botStatus" class="status stopped">Stopped</span>
                        </div>
                        <div class="stat-item">
                            <label>Progress:</label>
                            <span id="progress">0/0</span>
                        </div>
                        <div class="stat-item">
                            <label>Successful:</label>
                            <span id="success">0</span>
                        </div>
                        <div class="stat-item">
                            <label>Failed:</label>
                            <span id="fails">0</span>
                        </div>
                        <div class="stat-item">
                            <label>Requests:</label>
                            <span id="reqs">0</span>
                        </div>
                        <div class="stat-item">
                            <label>RPS:</label>
                            <span id="rps">0</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn stop-btn" onclick="stopBot()" disabled>üõë Stop Bot</button>
            </div>

            <!-- System Info -->
            <div class="section">
                <h3>‚öôÔ∏è System Information</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <label>Devices Loaded:</label>
                        <span id="devicesCount">14,000+</span>
                    </div>
                    <div class="stat-item">
                        <label>Concurrency:</label>
                        <span>200 threads</span>
                    </div>
                    <div class="stat-item">
                        <label>Target Mode:</label>
                        <span>Auto-stop on completion</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
        }
        
        // Set user email
        try {
            const userData = JSON.parse(atob(token.split('.')[1]));
            document.getElementById('userEmail').textContent = userData.email;
        } catch (e) {
            logout();
        }
        
        let statsInterval;
        
        // Start Bot
        async function startBot() {
            const target = document.getElementById('tiktokTarget').value;
            const url = document.getElementById('tiktokUrl').value;
            
            if (!target || !url) {
                alert('Please enter target views and TikTok URL');
                return;
            }
            
            try {
                const response = await fetch('/api/tiktok/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        target_views: target,
                        video_url: url
                    })
                });
                
                const data = await response.json();
                alert(data.success ? '‚úÖ Bot started successfully!' : '‚ùå Error: ' + data.message);
                
                if (data.success) {
                    document.querySelector('.start-btn').disabled = true;
                    document.querySelector('.stop-btn').disabled = false;
                    startStatsUpdate();
                    loadHistory();
                }
            } catch (error) {
                alert('‚ùå Network error starting bot');
            }
        }
        
        // Stop Bot
        function stopBot() {
            fetch('/api/tiktok/stop', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            }).then(() => {
                document.querySelector('.start-btn').disabled = false;
                document.querySelector('.stop-btn').disabled = true;
            });
        }
        
        // Update Stats
        async function startStatsUpdate() {
            if (statsInterval) clearInterval(statsInterval);
            
            statsInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/tiktok/stats', {
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        updateStatsDisplay(data);
                    }
                } catch (error) {
                    console.log('Error fetching stats');
                }
            }, 1000);
        }
        
        function updateStatsDisplay(data) {
            const statusElem = document.getElementById('botStatus');
            statusElem.textContent = data.running ? 'Running' : 'Stopped';
            statusElem.className = `status ${data.running ? 'running' : 'stopped'}`;
            
            document.getElementById('progress').textContent = `${data.stats.progress}/${data.stats.target_views}`;
            document.getElementById('success').textContent = data.stats.success;
            document.getElementById('fails').textContent = data.stats.fails;
            document.getElementById('reqs').textContent = data.stats.reqs;
            document.getElementById('rps').textContent = data.stats.rps;
            
            if (!data.running) {
                document.querySelector('.start-btn').disabled = false;
                document.querySelector('.stop-btn').disabled = true;
            }
        }
        
        // Paste URL
        function pasteUrl() {
            navigator.clipboard.readText().then(text => {
                document.getElementById('tiktokUrl').value = text;
            }).catch(err => {
                alert('üìã Paste failed. Please paste manually.');
            });
        }
        
        // Load History
        async function loadHistory() {
            try {
                const response = await fetch('/api/history', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = data.history.map(item => `
                        <div class="history-item" onclick="useHistory('${item.videoUrl}')">
                            <div class="history-url">${item.videoUrl.substring(0, 50)}...</div>
                            <div class="history-time">${new Date(item.timestamp).toLocaleString()}</div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('historyList').innerHTML = 'No history yet';
                }
            } catch (error) {
                document.getElementById('historyList').innerHTML = 'Error loading history';
            }
        }
        
        // Use History Item
        function useHistory(url) {
            document.getElementById('tiktokUrl').value = url;
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
        
        // Initial load
        startStatsUpdate();
        loadHistory();
    </script>
</body>
</html>
